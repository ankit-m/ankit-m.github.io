{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/ui-testing-with-puppeteer-and-mocha/","result":{"data":{"site":{"siteMetadata":{"title":"Ankit Muchhala","siteUrl":"https://ankit-m.github.io"}},"markdownRemark":{"id":"e82382ca-b3b9-5e1c-83b0-8fe47f734d9e","excerpt":"1. Introduction ü§ù If you have ever built a web app, you know the pain of testing the entire application every time you add a new feature. Yes, you just‚Ä¶","html":"<h2>1. Introduction ü§ù</h2>\n<p>If you have ever built a web app, you know the pain of testing the entire application every time you add a new feature. Yes, you just modified one isolated module of the code and it _should not_affect anything else. But there a tiny sliver of doubt in a dark corner of your mind, ‚ÄúWhat if it broke something?‚Äù.</p>\n<p>To remove this doubt, you spend quite a lot of time testing all other flows to make sure you did not accidentally break anything <em>major</em>. There is always a chance of you missing edge cases. So you go ahead and deploy with the hope that nothing breaks. By no means, is this a reliable way of testing. But we still do it. The only way to get rid of this unreliability is to write tests which verify your flows viz. <strong>UI Testing</strong>.</p>\n<p>This series is an attempt to get you started with UI testing using <strong>puppeteer</strong> and <strong>mocha</strong>. It starts from scratch and assumes basic knowledge of JavaScript. Part 1 deals with setting up and getting started with puppeteer.</p>\n<h2>2. The Toolkit üéí</h2>\n<h3>2.a Mocha</h3>\n<p><a href=\"https://mochajs.org/\">Mocha</a> is a JavaScript testing framework. It provides a lot of methods like <code class=\"language-text\">describe</code>, <code class=\"language-text\">it</code>, <code class=\"language-text\">before</code>, etc. to organise your tests. It provides both command line and programmatic utilities to execute the tests.</p>\n<h3>2.b Chai</h3>\n<p>Mocha by itself is not of much help to us. You need an assertion library with it to actually test things. We will use <a href=\"http://chaijs.com/\">ChaiJS</a> throughout this series. There are other options like expect.js, should.js, etc.</p>\n<h3>2.c Puppeteer</h3>\n<p><a href=\"https://github.com/GoogleChrome/puppeteer\">Puppeteer</a> is a node wrapper around <a href=\"https://developers.google.com/web/updates/2017/04/headless-chrome\">headless Chrome</a> which started shipping with Chrome 59 (For Windows Chrome 60). It provides a lot of convenient methods to access and manipulate DOM, cookies, requests, etc.</p>\n<p>We will use these APIs to access the rendered UI elements and run assertions on them to check if things are working as expected.</p>\n<h2>3. Basic testing setup üê£</h2>\n<p>Open your terminal and create a new project. You need Node installed on your computer which will expose a <code class=\"language-text\">node</code> and <code class=\"language-text\">npm</code> command. I recommend using <a href=\"https://github.com/creationix/nvm\">nvm</a> to manage node versions. This series uses Node <code class=\"language-text\">v8.9.1</code> and npm <code class=\"language-text\">v5.5.1</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mkdir</span> puppeteer-mocha\n<span class=\"token builtin class-name\">cd</span> puppeteer-mocha\n<span class=\"token function\">npm</span> init ‚Äîyes\n<span class=\"token function\">npm</span> i ‚Äîsave mocha@4.0.1 puppeteer@0.13.0 chai@4.1.2 http-server@0.10.0</code></pre></div>\n<blockquote>\n<p>All packages are suffixed with versions to make this future proof. You can skip them if you want. We install <code class=\"language-text\">http-server</code> to start a basic http server for testing. If you already have a server running with a website, you can simply use that.</p>\n</blockquote>\n<p>Now we will create</p>\n<ol>\n<li>Add <code class=\"language-text\">test</code> folder which will contain all the test files</li>\n<li>Add <code class=\"language-text\">src</code> folder which house our test website</li>\n<li>Add npm scripts for starting our server and running tests</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">mkdir</span> <span class=\"token builtin class-name\">test</span> src\n<span class=\"token function\">touch</span> test/sample.spec.js\n<span class=\"token function\">touch</span> src/index.html</code></pre></div>\n<p>To start off, we will create a very basic website which we can test. Here is what <code class=\"language-text\">index.html</code> looks like.</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token doctype\"><span class=\"token punctuation\">&lt;!</span><span class=\"token doctype-tag\">DOCTYPE</span> <span class=\"token name\">html</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>title</span><span class=\"token punctuation\">></span></span>Puppeteer Mocha<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>title</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h1</span><span class=\"token punctuation\">></span></span>Page Title<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h1</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>main-content<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>Some paragraph text<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>Now add the following two scripts to your package.json . The test script tells mocha to execute all files in the folder test . The recursive option tells it to go inside directories, if any, and get files. The server script serves your index.html on <a href=\"http://127.0.0.1:8080/\">http://127.0.0.1:8080</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\">...\n<span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"test\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"mocha --recursive test\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"server\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"http-server src\"</span>\n <span class=\"token punctuation\">}</span>\n...</code></pre></div>\n<p>Finally, let‚Äôs add a sample test to check if everything is working as expected. Add the following code to <code class=\"language-text\">sample.spec.js</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> expect <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"chai\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sample test\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"should work\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span>be<span class=\"token punctuation\">.</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Now run <code class=\"language-text\">npm test</code> and you should see an output like this -</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sample test\n  ‚úì should work</code></pre></div>\n<h2>4. Bringing in Puppeteer üöÇ</h2>\n<p>We want to start one instance of the browser (headless Chrome in this case) and reuse the same instance to run all our tests. Each test will open a new tab, browse to the URL, run tests against the view and then close the tab. We will do all the setup in <code class=\"language-text\">test/bootstrap.js</code> and expose required variables to be used across tests.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> puppeteer <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"puppeteer\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> expect <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"chai\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> _ <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"lodash\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> globalVariables <span class=\"token operator\">=</span> _<span class=\"token punctuation\">.</span><span class=\"token function\">pick</span><span class=\"token punctuation\">(</span>global<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"browser\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"expect\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// puppeteer options</span>\n<span class=\"token keyword\">const</span> opts <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  headless<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n  slowMo<span class=\"token operator\">:</span> <span class=\"token number\">100</span><span class=\"token punctuation\">,</span>\n  timeout<span class=\"token operator\">:</span> <span class=\"token number\">10000</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// expose variables</span>\n<span class=\"token function\">before</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  global<span class=\"token punctuation\">.</span>expect <span class=\"token operator\">=</span> expect<span class=\"token punctuation\">;</span>\n  global<span class=\"token punctuation\">.</span>browser <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> puppeteer<span class=\"token punctuation\">.</span><span class=\"token function\">launch</span><span class=\"token punctuation\">(</span>opts<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// close browser and reset global variables</span>\n<span class=\"token function\">after</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  browser<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  global<span class=\"token punctuation\">.</span>browser <span class=\"token operator\">=</span> globalVariables<span class=\"token punctuation\">.</span>browser<span class=\"token punctuation\">;</span>\n  global<span class=\"token punctuation\">.</span>expect <span class=\"token operator\">=</span> globalVariables<span class=\"token punctuation\">.</span>expect<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The <code class=\"language-text\">before</code> block is responsible to setup everything required for all the tests. It will execute once before all tests. It exposes the <code class=\"language-text\">browser</code> instance and <code class=\"language-text\">expect</code> function so that we don‚Äôt have to require it in all the test files. The <code class=\"language-text\">after</code> block cleans up the environment, once all tests are completed. I have also used <a href=\"https://lodash.com/\">Lodash</a> for some convenience methods.</p>\n<p>The important things to note are <code class=\"language-text\">puppeteer.launch</code> and <code class=\"language-text\">opts</code>. As the name suggests, <code class=\"language-text\">launch</code> starts a chrome browser based on the options provided.</p>\n<ul>\n<li>I have turned off the headless mode with <code class=\"language-text\">headless: false</code>. This will open a Chromium window when you run the test.</li>\n<li>Added timeout of 10 seconds (any test taking longer than that will fail)</li>\n<li>Slowed down each operation by <code class=\"language-text\">100ms</code>. This is not required right now, but comes in handy when you want to see what is happening in the browser.</li>\n</ul>\n<p>You need to tweak your test script a little</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\">...\n<span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"test\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"mocha test/bootstrap.js --recursive test\"</span><span class=\"token punctuation\">,</span>\n...</code></pre></div>\n<p>We will now update <code class=\"language-text\">test/sample.spec.js</code>. To do something with this browser instance exposed. To check, we just log the browser version.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// test/sample.spec.js</span>\n<span class=\"token function\">describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sample test\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"should work\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">await</span> browser<span class=\"token punctuation\">.</span><span class=\"token function\">version</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span>be<span class=\"token punctuation\">.</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Now, when you run <code class=\"language-text\">npm test</code>. You should see the Chrome version logged. The version might differ for you as puppeteer installs the latest version of Chromium available.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sample test\nChrome/64.0.3264.0\n   ‚úì should work (103ms)</code></pre></div>\n<h3>4.a Without using async/await</h3>\n<p>For many reasons you might not prefer to use async/await syntax. You can achieve the exact same by just using promises. Since most puppeteer functions return promises, all you have to do is wait for them to resolve. The mocha <code class=\"language-text\">done</code> method comes in handy.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// test/sample.spec.js</span>\n\n<span class=\"token function\">describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sample test\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"should work\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">done</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    browser<span class=\"token punctuation\">.</span><span class=\"token function\">version</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">v</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span>be<span class=\"token punctuation\">.</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// test/bootstrap.js</span>\n\n<span class=\"token keyword\">const</span> puppeteer <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"puppeteer\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> expect <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"chai\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> _ <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"lodash\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> globalVariables <span class=\"token operator\">=</span> _<span class=\"token punctuation\">.</span><span class=\"token function\">pick</span><span class=\"token punctuation\">(</span>global<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"browser\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"expect\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// puppeteer options</span>\n<span class=\"token keyword\">const</span> opts <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  headless<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n  slowMo<span class=\"token operator\">:</span> <span class=\"token number\">100</span><span class=\"token punctuation\">,</span>\n  timeout<span class=\"token operator\">:</span> <span class=\"token number\">10000</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// expose variables</span>\n<span class=\"token function\">before</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">done</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  global<span class=\"token punctuation\">.</span>expect <span class=\"token operator\">=</span> expect<span class=\"token punctuation\">;</span>\n\n  puppeteer<span class=\"token punctuation\">.</span><span class=\"token function\">launch</span><span class=\"token punctuation\">(</span>opts<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">browser</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    global<span class=\"token punctuation\">.</span>browser <span class=\"token operator\">=</span> browser<span class=\"token punctuation\">;</span>\n    <span class=\"token function\">done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// close browser and reset global variables</span>\n<span class=\"token function\">after</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  browser<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  global<span class=\"token punctuation\">.</span>browser <span class=\"token operator\">=</span> globalVariables<span class=\"token punctuation\">.</span>browser<span class=\"token punctuation\">;</span>\n  global<span class=\"token punctuation\">.</span>expect <span class=\"token operator\">=</span> globalVariables<span class=\"token punctuation\">.</span>expect<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>I prefer using <code class=\"language-text\">async/await</code> as it looks cleaner and is much more readable, especially for more complex tests.</p>\n<p>You can view the code at this stage <a href=\"https://github.com/ankit-m/puppeteer-mocha/tree/integrate-puppeteer\">here</a>.</p>\n<h2>5. Writing your first UI test üöÄ</h2>\n<p>Now that we have set things up, it‚Äôs time to write tests. This is how our webpage looks right now. Pretty boring! I agree.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/be398e4d11f4d84febc5e9758989246b/3508d/web-page.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 12.658227848101264%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAFUlEQVQI12P4+/fvP3IBw38KAEWaAfQ1sw44O0WVAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Sample web page\"\n        title=\"Sample web page\"\n        src=\"/static/be398e4d11f4d84febc5e9758989246b/f058b/web-page.png\"\n        srcset=\"/static/be398e4d11f4d84febc5e9758989246b/c26ae/web-page.png 158w,\n/static/be398e4d11f4d84febc5e9758989246b/6bdcf/web-page.png 315w,\n/static/be398e4d11f4d84febc5e9758989246b/f058b/web-page.png 630w,\n/static/be398e4d11f4d84febc5e9758989246b/40601/web-page.png 945w,\n/static/be398e4d11f4d84febc5e9758989246b/78612/web-page.png 1260w,\n/static/be398e4d11f4d84febc5e9758989246b/3508d/web-page.png 3316w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>We want to test the following things:</p>\n<ol>\n<li>The page title is ‚ÄúPuppeteer Mocha‚Äù</li>\n<li>The heading is ‚ÄúPage Title‚Äù (Sorry for the confusing heading)</li>\n<li>There is a paragraph with ‚ÄúSome paragraph text‚Äù in it</li>\n</ol>\n<p>Puppeteer has a lot of classes like Page, Frame, Request, etc. Each of these classes provide helper methods to access and interact with the page content. The usual workflow is to open the page, wait for a selector and then validate the content once the selectors resolve. This is how basic tests look like:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// test/sample.spec.js</span>\n\n<span class=\"token function\">describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sample test\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> page<span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">before</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    page <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> browser<span class=\"token punctuation\">.</span><span class=\"token function\">newPage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">await</span> page<span class=\"token punctuation\">.</span><span class=\"token function\">goto</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"http://localhost:8080\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">after</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">await</span> page<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"should have the correct page title\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">await</span> page<span class=\"token punctuation\">.</span><span class=\"token function\">title</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span><span class=\"token function\">eql</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Puppeteer Mocha\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"should have a heading\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token constant\">HEADING_SELECTOR</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"h1\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> heading<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">await</span> page<span class=\"token punctuation\">.</span><span class=\"token function\">waitFor</span><span class=\"token punctuation\">(</span><span class=\"token constant\">HEADING_SELECTOR</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    heading <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> page<span class=\"token punctuation\">.</span><span class=\"token function\">$eval</span><span class=\"token punctuation\">(</span><span class=\"token constant\">HEADING_SELECTOR</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">heading</span> <span class=\"token operator\">=></span> heading<span class=\"token punctuation\">.</span>innerText<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>heading<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span><span class=\"token function\">eql</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Page Title\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"should have a single content section\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token constant\">BODY_SELECTOR</span> <span class=\"token operator\">=</span> <span class=\"token string\">\".main-content\"</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">await</span> page<span class=\"token punctuation\">.</span><span class=\"token function\">waitFor</span><span class=\"token punctuation\">(</span><span class=\"token constant\">BODY_SELECTOR</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">await</span> page<span class=\"token punctuation\">.</span><span class=\"token function\">$$</span><span class=\"token punctuation\">(</span><span class=\"token constant\">BODY_SELECTOR</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span>have<span class=\"token punctuation\">.</span><span class=\"token function\">lengthOf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>There is a lot going on in this spec file. Let‚Äôs look at it one by one.</p>\n<p>We first open a new page in the <code class=\"language-text\">before</code> block and navigate to <a href=\"http://localhost:8080./\">http://localhost:8080.</a> This is equivalent to you opening a new tab in chrome, typing the URL and pressing enter. Since, the variable page is defined in the <code class=\"language-text\">describe</code> block, all <code class=\"language-text\">it</code> blocks (specs) have access to the page. This allows us to segregate our tests and make them more readable.</p>\n<p>The first test simply checks the page title and expects it to be equal to ‚ÄúPuppeteer Mocha‚Äù.</p>\n<p>The second test checks for the heading. <code class=\"language-text\">page.$eval</code> takes two arguments <code class=\"language-text\">selector</code> and <code class=\"language-text\">pageFunction</code>. It runs a <code class=\"language-text\">document.querySelector</code> in the browser environment and passes the result to the <code class=\"language-text\">pageFunction</code>. Finally, it resolves with the value returned by <code class=\"language-text\">pageFunction</code>. In this case, we are just returning the text for <code class=\"language-text\">h1</code> tag.</p>\n<p>The third test checks for the existence of just one element with class <code class=\"language-text\">main-content</code>. The <code class=\"language-text\">page.$$</code> expects only the selector as a parameter. It runs a <code class=\"language-text\">document.querySelectorAll</code> in the browser environment and returns an array of <code class=\"language-text\">elementHandle</code>. You can imagine <code class=\"language-text\">elementHandle</code> as a wrapper around an HTML element with helper functions which make it easier to interact and test them.</p>\n<p>You can view the code at this stage <a href=\"https://github.com/ankit-m/puppeteer-mocha/tree/basic-tests\">here</a>.</p>\n<h2>6. Conclusion üíØ</h2>\n<p>In this part we have barely scraped the surface of puppeteer. I hope you have gotten a feel of UI testing. Over the next parts, we will dive deep into testing complex webpages and interactions.</p>","frontmatter":{"title":"UI Testing with Puppeteer and Mocha - Part 1","date":"November 21, 2017","description":"Puppeteer is a great tool to programmatically test UIs. This blogpost will help you setup puppeteer with mocha and write basic tests.","image":null}},"previous":{"fields":{"slug":"/kya-banau-chotu/"},"frontmatter":{"title":"Kya Banau Chotu? (What should I make kiddo?)"}},"next":{"fields":{"slug":"/building-highly-customizable-react-components/"},"frontmatter":{"title":"Building highly customizable React components"}}},"pageContext":{"id":"e82382ca-b3b9-5e1c-83b0-8fe47f734d9e","previousPostId":"b456d509-1926-54b1-98ae-4f129a384491","nextPostId":"14c8fdbf-68f4-5c1a-aba5-b0c4844c6ac7"}},"staticQueryHashes":["2841359383","3257411868"]}